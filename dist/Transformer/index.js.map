{"version":3,"file":"index.js","sources":["../../node_modules/style-inject/dist/style-inject.es.js","../../lib/ui/transformer/index.js"],"sourcesContent":["function styleInject(css, ref) {\n  if ( ref === void 0 ) ref = {};\n  var insertAt = ref.insertAt;\n\n  if (!css || typeof document === 'undefined') { return; }\n\n  var head = document.head || document.getElementsByTagName('head')[0];\n  var style = document.createElement('style');\n  style.type = 'text/css';\n\n  if (insertAt === 'top') {\n    if (head.firstChild) {\n      head.insertBefore(style, head.firstChild);\n    } else {\n      head.appendChild(style);\n    }\n  } else {\n    head.appendChild(style);\n  }\n\n  if (style.styleSheet) {\n    style.styleSheet.cssText = css;\n  } else {\n    style.appendChild(document.createTextNode(css));\n  }\n}\n\nexport default styleInject;\n","import './index.css'\n\nconst CIRCLES = [\n  'top-left',\n  'top-right',\n  'bottom-left',\n  'bottom-right'\n]\n\nconst CIRCLE_RADIO = 6\n\nclass Transformer {\n  static pluginName = 'transformer'\n  constructor (muya, options) {\n    this.muya = muya\n    this.options = options\n    this.reference = null\n    this.imageInfo = null\n    this.movingAnchor = null\n    this.status = false\n    this.width = null\n    this.eventId = []\n    this.lastScrollTop = null\n    this.resizing = false\n    const container = this.container = document.createElement('div')\n    container.classList.add('ag-transformer')\n    document.body.appendChild(container)\n    this.listen()\n  }\n\n  listen () {\n    const { eventCenter, container } = this.muya\n    const scrollHandler = event => {\n      if (typeof this.lastScrollTop !== 'number') {\n        this.lastScrollTop = event.target.scrollTop\n        return\n      }\n      // only when scoll distance great than 50px, then hide the float box.\n      if (!this.resizing && this.status && Math.abs(event.target.scrollTop - this.lastScrollTop) > 50) {\n        this.hide()\n      }\n    }\n    eventCenter.attachDOMEvent(document, 'click', this.hide.bind(this))\n    eventCenter.subscribe('muya-transformer', ({ reference, imageInfo }) => {\n      this.reference = reference\n      if (reference) {\n        this.imageInfo = imageInfo\n        setTimeout(() => {\n          this.render()\n        })\n      } else {\n        this.hide()\n      }\n    })\n\n    eventCenter.attachDOMEvent(container, 'scroll', scrollHandler)\n    eventCenter.attachDOMEvent(this.container, 'dragstart', event => event.preventDefault())\n    eventCenter.attachDOMEvent(document.body, 'mousedown', this.mouseDown)\n  }\n\n  render () {\n    const { eventCenter } = this.muya\n    if (this.status) {\n      this.hide()\n    }\n    this.status = true\n\n    this.createElements()\n    this.update()\n    eventCenter.dispatch('muya-float', this, true)\n  }\n\n  createElements () {\n    CIRCLES.forEach(c => {\n      const circle = document.createElement('div')\n      circle.classList.add('circle')\n      circle.classList.add(c)\n      circle.setAttribute('data-position', c)\n      this.container.appendChild(circle)\n    })\n  }\n\n  update () {\n    const rect = this.reference.getBoundingClientRect()\n    CIRCLES.forEach(c => {\n      const circle = this.container.querySelector(`.${c}`)\n\n      switch (c) {\n        case 'top-left':\n          circle.style.left = `${rect.left - CIRCLE_RADIO}px`\n          circle.style.top = `${rect.top - CIRCLE_RADIO}px`\n          break\n        case 'top-right':\n          circle.style.left = `${rect.left + rect.width - CIRCLE_RADIO}px`\n          circle.style.top = `${rect.top - CIRCLE_RADIO}px`\n          break\n        case 'bottom-left':\n          circle.style.left = `${rect.left - CIRCLE_RADIO}px`\n          circle.style.top = `${rect.top + rect.height - CIRCLE_RADIO}px`\n          break\n        case 'bottom-right':\n          circle.style.left = `${rect.left + rect.width - CIRCLE_RADIO}px`\n          circle.style.top = `${rect.top + rect.height - CIRCLE_RADIO}px`\n          break\n      }\n    })\n  }\n\n  mouseDown = (event) => {\n    const target = event.target\n    if (!target.closest('.circle')) return\n    const { eventCenter } = this.muya\n    this.movingAnchor = target.getAttribute('data-position')\n    const mouseMoveId = eventCenter.attachDOMEvent(document.body, 'mousemove', this.mouseMove)\n    const mouseUpId = eventCenter.attachDOMEvent(document.body, 'mouseup', this.mouseUp)\n    this.resizing = true\n    // Hide image toolbar\n    eventCenter.dispatch('muya-image-toolbar', { reference: null })\n    this.eventId.push(mouseMoveId, mouseUpId)\n  }\n\n  mouseMove = (event) => {\n    const clientX = event.clientX\n    let width\n    let relativeAnchor\n    const image = this.reference.querySelector('img')\n    if (!image) {\n      return\n    }\n    switch (this.movingAnchor) {\n      case 'top-left':\n      case 'bottom-left':\n        relativeAnchor = this.container.querySelector('.top-right')\n        width = Math.max(relativeAnchor.getBoundingClientRect().left + CIRCLE_RADIO - clientX, 50)\n        break\n      case 'top-right':\n      case 'bottom-right':\n        relativeAnchor = this.container.querySelector('.top-left')\n        width = Math.max(clientX - relativeAnchor.getBoundingClientRect().left - CIRCLE_RADIO, 50)\n        break\n    }\n    // Image width/height attribute must be an integer.\n    width = parseInt(width)\n    this.width = width\n    image.setAttribute('width', width)\n    this.update()\n  }\n\n  mouseUp = (event) => {\n    const { eventCenter } = this.muya\n    if (this.eventId.length) {\n      for (const id of this.eventId) {\n        eventCenter.detachDOMEvent(id)\n      }\n      this.eventId = []\n    }\n    // todo update data\n    if (typeof this.width === 'number') {\n      this.muya.contentState.updateImage(this.imageInfo, 'width', this.width)\n      this.width = null\n      this.hide()\n    }\n    this.resizing = false\n    this.movingAnchor = null\n  }\n\n  hide () {\n    const { eventCenter } = this.muya\n    const circles = this.container.querySelectorAll('.circle')\n    Array.from(circles).forEach(c => c.remove())\n    this.status = false\n    eventCenter.dispatch('muya-float', this, false)\n  }\n}\n\nexport default Transformer\n"],"names":["CIRCLES","CIRCLE_RADIO","Transformer","constructor","muya","options","mouseDown","event","target","closest","eventCenter","movingAnchor","getAttribute","mouseMoveId","attachDOMEvent","document","body","mouseMove","mouseUpId","mouseUp","resizing","dispatch","reference","eventId","push","clientX","width","relativeAnchor","image","querySelector","container","Math","max","getBoundingClientRect","left","parseInt","setAttribute","update","length","id","detachDOMEvent","contentState","updateImage","imageInfo","hide","status","lastScrollTop","createElement","classList","add","appendChild","listen","scrollHandler","scrollTop","abs","bind","subscribe","setTimeout","render","preventDefault","createElements","forEach","c","circle","rect","style","top","height","circles","querySelectorAll","Array","from","remove","pluginName"],"mappings":"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"}